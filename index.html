<!doctype html>
<html>
<head>
  <script src="http://code.jquery.com/jquery-latest.min.js"></script>
  <script src="js/lib/jquery.dataTables.min.js"></script>
  <script src="js/lib/jquery.qtip.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="js/lib/d3-timeline.js"></script>
  <link href="css/lib/jquery.qtip.min.css" type="text/css" rel="stylesheet"></link>
  <link href="css/lib/dataTables.tableTools.min.css" type="text/css" rel="stylesheet"></link>
  <style type="text/css">
    .axis path,
    .axis line {
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
    }

    .axis text {
      font-family: sans-serif;
      font-size: 10px;
    }

    .timeline-label {
      font-family: sans-serif;
      font-size: 12px;
    }

    body {
      text-align: center;
    }
    #jsonInput {
      width: 500px;
      height: 500px;
    }
  </style>
  <script>
    var allData;

    window.onload = function() {
      $("#jsonInput").val(JSON.stringify(testDataRelativeDays, null, '    '));
      $("#parseJson").on("click", function() {
        allData = JSON.parse($("#jsonInput").val())
        timelineRelativeDays(allData);
      });
      $("#parseJson").click();
    }
    var testDataRelativeDays = [
      {label:"surgery", times:[{"starting_time": 1, "ending_time": 2},
          {"starting_time": 2, "ending_time": 3}],visible:true},
      {label:"diagnosis", times: [{"starting_time": 3, "ending_time":
              4}],visible:true},
      {label:"status", times: [{"starting_time": 9, "ending_time": 9,
          "display":"circle"}],visible:true},
    ];
    function createDataTable(elem) {
      var d = elem.prop("__data__");
      var attributes = [];
      for (k in d) {
        attributes.push([k, d[k]]);
      };
      dataTable = {
                      "dom": 'C<"clear">lfrtip',
                      "sDom": 't',
                      "bJQueryUI": true,
                      "bDestroy": true,
                      "aaData": attributes,
                      "aoColumnDefs": [
                          {
                              "aTargets": [ 0 ],
                              "sClass": "left-align-td",
                              "mRender": function ( data, type, full ) {
                                  return '<b>'+data+'</b>';
                              }
                          },
                          {
                              "aTargets": [ 1 ],
                              "sClass": "left-align-td",
                              "bSortable": false
                          }
                      ],
                      "aaSorting": [[0,'asc']],
                      "oLanguage": {
                          "sInfo": "&nbsp;&nbsp;(_START_ to _END_ of _TOTAL_)&nbsp;&nbsp;",
                          "sInfoFiltered": "",
                          "sLengthMenu": "Show _MENU_ per page"
                      },
                      "iDisplayLength": -1
                  };
      return dataTable;
    }
    function addDataPointToolTip(elem) {
         elem.qtip({
                content: {
                    text: "table"
                },
                events: {
                    render: function(event, api) {
                        $(this).html("<table style='background-color: white;'></table>");
                        $(this).find("table").dataTable(createDataTable(elem));
                        // Detect when point it was clicked and store it
                        api.elements.target.click(function(e) {
                            if (api.wasClicked) {
                                api.hide();
                                api.wasClicked = false;
                            }
                            else {
                                api.wasClicked = !api.wasClicked;
                            }
                        });
                    },
                    hide: function(event, api) {
                         // Prevent hiding if the point was clicked or if the
                         // tooltip is already showing because of the mouseover
                         if ((api.wasClicked && event.originalEvent.type === 'mouseleave') ||
                             (!api.wasClicked && event.originalEvent.type === 'click')) {
                             try{ event.preventDefault(); } catch(e) {}
                         }
                     }
                },
                show: {event: "click mouseover"},
                hide: {event: "click mouseleave"},
                style: { classes: 'qtip-light qtip-rounded qtip-wide' },
                position: {my:'top middle',at:'bottom middle',viewport: $(window)},
            }); 
    }
    function toggleTrackVisibility(trackName) {
       $.each(allData, function(i, x) {
         if (x.label == trackName) {
            x.visible = x.visible? false : true;
         }
       });
       timelineRelativeDays(allData);
    }
    function addNewTrackTooltip(elem) {
        elem.qtip({
                content: {
                    text: 'addtrack'
                },
                events: {
                    render: function(event, api) {
                        invisibleTracks = allData.filter(function (x) {
                          return !x.visible
                        });
                        if (invisibleTracks.length == 0) {
                            $(this).html("All tracks shown");
                        }
                        else {
                            var trackAnchors = "";
                            for (var i=0; i<invisibleTracks.length; i++) {
                                trackAnchors +=
                                    "<a href='#' class='show-track'>"+invisibleTracks[i].label+"</a><br />";
                            }
                            $(this).html(trackAnchors);
                            $('.show-track').each(function () {
                                $(this).on("click", function() {
                                    toggleTrackVisibility($(this).prop("innerHTML"));
                                });
                            });
                        }
                    }
                },
                show: {event: "mouseover"},
                hide: {fixed: true, delay: 0, event: "mouseout"},
                style: { classes: 'qtip-light qtip-rounded qtip-wide' },
                position: {my:'top middle',at:'top middle',viewport: $(window)},
        })
    }
    function addTrackTooltip(elem) {
         elem.qtip({
                content: {
                    text: 'track'
                },
                events: {
                    render: function(event, api) {
                        var a = $.parseHTML("<a href='#'>Hide " + elem.prop("innerHTML")
                            + "</a>");
                        $(a).on("click", function() {
                            toggleTrackVisibility(elem.prop("innerHTML"));
                        });
                        $(this).html(a);
                    }
                },
                show: {event: "mouseover"},
                hide: {fixed: true, delay: 0, event: "mouseout"},
                style: { classes: 'qtip-light qtip-rounded qtip-wide' },
                position: {my:'top middle',at:'top middle',viewport: $(window)},
            });
    }
    function filterTrack(data, track) {
        return data.filter(function(x) {
            return x.label != track
        })
    }
    function timelineRelativeDays(data) {
      var chart = d3.timeline()
        .relativeTime()
        .stack()
        .margin({left:150, right:30, top:15, bottom:0})
        .tickFormat({
          format: function(d) { return d3.time.format("%_d d")(d3.time.day.offset(new Date("2000-01-02"), d.valueOf()))},
          tickInterval: 1,
          tickSize: 6,
        })
        .orient('top');

      var width = 500;
      $("#timelineRelativeDays").html("");
      var svg = d3.select("#timelineRelativeDays").append("svg").attr("width", width)
        .datum(data.filter(function(x) {
          return x.visible
        })).call(chart);
      $("[id^='timelineItem']").each(function() {
        addDataPointToolTip($(this));
      });
      $(".timeline-label").each(function() {
        addTrackTooltip($(this));
      });
      svg.attr("height", parseInt(svg.attr("height")) + 15)
      svg.insert("text")
        .attr("transform", "translate(0, 15)")
        .attr("class", "timeline-label")
        .text("Time since diagnosis");
      svg.insert("text")
        .attr("transform", "translate(0,"+(d3.select("svg").attr("height"))+")")
        .attr("class", "timeline-label")
        .text("add track")
        .attr("id", "addtrack");
      addNewTrackTooltip($("#addtrack"));
      d3.select(".axis").attr("transform", "translate(0,20)")
    }
  </script>
</head>
<body>
  <div>
    <h3>clinical timeline</h3>
    <div width="100%" id="timelineRelativeDays"></div>
    <h4>data</h4>
    <button id="parseJson">Parse JSON</button><br />
    <textarea id="jsonInput">
    </textarea>
  </div>
</body>
</html>
